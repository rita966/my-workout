<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ’ªğŸ» è¨“ç·´ç«™</title>
    <style>
        :root {
            --bg: #F5F2ED; --card: #FFFFFF; --primary: #8C7851; --accent: #B0A990;
            --text: #333; --gray: #F0F0F0; --ss-bg: #EAE7DC; --save: #6B705C; --danger: #CC6666;
        }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 600px; }
        
        /* æ§åˆ¶é¢æ¿ */
        .admin-bar { background: white; padding: 12px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; width: 100%; box-sizing: border-box; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .btn { border: none; border-radius: 6px; padding: 8px 10px; cursor: pointer; font-size: 11px; font-weight: bold; }
        .btn-sync { background: var(--primary); color: white; }
        .btn-save { background: var(--save); color: white; }
        .btn-copy { background: #EEE; color: #666; }

        .week-selector { display: flex; gap: 4px; margin-bottom: 10px; width: 100%; }
        .day-tab { flex: 1; text-align: center; padding: 12px 0; background: #DDD; border-radius: 8px; font-size: 13px; cursor: pointer; }
        .day-tab.active { background: var(--primary); color: white; }

        .table-header { display: grid; grid-template-columns: 40px 1fr 60px 60px 40px; gap: 4px; padding: 10px 5px; background: var(--primary); color: white; border-radius: 8px 8px 0 0; font-size: 11px; text-align: center; }
        .ex-module { border: 1px solid #EEE; margin-bottom: 15px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .ex-row { display: grid; grid-template-columns: 40px 1fr 60px 60px 40px; gap: 4px; padding: 8px 5px; border-bottom: 1px solid #F0F0F0; align-items: center; }
        .ss-active { background: var(--ss-bg); }
        
        input { border: 1px solid #DDD; border-radius: 4px; padding: 6px 2px; text-align: center; font-size: 13px; width: 100%; }
        .name-input { border: none; text-align: left; font-weight: bold; background: transparent; }
        
        .btn-check { height: 32px; width: 32px; border-radius: 4px; border: 1px solid #DDD; background: #EEE; cursor: pointer; }
        .btn-check.done { background: var(--save); color: white; border: none; }

        .module-tools { display: flex; gap: 10px; padding: 5px 10px; background: #FAFAFA; border-bottom: 1px solid #EEE; font-size: 10px; color: #AAA; }
        .add-ex-btn { background: var(--primary); color: white; width: 55px; height: 55px; border-radius: 50%; font-size: 30px; position: fixed; bottom: 20px; right: 20px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 100; }
        
        .loading { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>

<div id="loader" class="loading">é›²ç«¯å‚³è¼¸ä¸­...</div>

<div class="container">
    <div class="admin-bar">
        <div id="timer-display" style="font-weight:bold; color:var(--primary); font-size:14px;">â±ï¸ 00:00</div>
        <div style="display:flex; gap:5px;">
            <button class="btn btn-copy" onclick="copyToday()">è¤‡è£½å¤©</button>
            <button class="btn btn-copy" onclick="pasteToday()">è²¼ä¸Šå¤©</button>
            <button class="btn btn-sync" onclick="loadFromCloud()">æ‹‰å–</button>
            <button class="btn btn-save" onclick="saveToCloud()">å„²å­˜ç™¼ä½ˆ</button>
        </div>
    </div>

    <div class="week-selector">
        <div class="day-tab active" onclick="changeDay(0)">ä¸€</div>
        <div class="day-tab" onclick="changeDay(1)">äºŒ</div>
        <div class="day-tab" onclick="changeDay(2)">ä¸‰</div>
        <div class="day-tab" onclick="changeDay(3)">å››</div>
        <div class="day-tab" onclick="changeDay(4)">äº”</div>
        <div class="day-tab" onclick="changeDay(5)">å…­</div>
        <div class="day-tab" onclick="changeDay(6)">æ—¥</div>
    </div>

    <div class="table-header">
        <div>é …æ¬¡</div><div>å‹•ä½œåç¨±</div><div>é‡é‡</div><div>æ¬¡æ•¸</div><div>âœ“</div>
    </div>
    <div id="exercise-list"></div>
</div>

<button class="add-ex-btn" onclick="addExercise()">+</button>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzdppLufdX1_LV4Tz1Jo8OOiBswmVY2vEiGS19-fYQGVhLtyuqbJ1cnCPJ0c_rkC7y6oQ/exec';

    let currentDay = 0;
    let workoutData = Array(7).fill().map(() => []);
    let clipboard = null; // æš«å­˜å‰ªè²¼ç°¿

    // æŠ“å–é›²ç«¯
    async function loadFromCloud() {
        if(SCRIPT_URL.includes('ä½ çš„')) { alert('è«‹å…ˆè¨­å®š SCRIPT_URL'); return; }
        showLoader(true);
        try {
            const response = await fetch(SCRIPT_URL);
            const rawData = await response.json();
            workoutData = Array(7).fill().map(() => []);
            rawData.slice(1).forEach(row => {
                const d = parseInt(row[0]);
                workoutData[d].push({
                    name: row[1], rest: row[2], isSS: row[3] == 1,
                    sets: JSON.parse(row[4])
                });
            });
            render();
        } catch (e) { alert("è®€å–å¤±æ•—"); }
        showLoader(false);
    }

    // å„²å­˜é›²ç«¯
    async function saveToCloud() {
        showLoader(true);
        const flatData = [];
        workoutData.forEach((dayArr, dIdx) => {
            dayArr.forEach(ex => {
                flatData.push({ day: dIdx, name: ex.name, rest: ex.rest, isSS: ex.isSS ? 1 : 0, sets: ex.sets });
            });
        });
        try {
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(flatData) });
            alert("é›²ç«¯åŒæ­¥æˆåŠŸï¼");
        } catch (e) { alert("å„²å­˜å¤±æ•—"); }
        showLoader(false);
    }

    // è¤‡è£½èˆ‡è²¼ä¸ŠåŠŸèƒ½
    function copyToday() {
        clipboard = JSON.stringify(workoutData[currentDay]);
        alert("å·²è¤‡è£½ä»Šæ—¥èª²è¡¨æ¨¡çµ„");
    }
    function pasteToday() {
        if(!clipboard) { alert("è«‹å…ˆè¤‡è£½æŸä¸€å¤©çš„èª²è¡¨"); return; }
        if(confirm("è¦è¦†è“‹ä»Šå¤©çš„èª²è¡¨å—ï¼Ÿ")) {
            workoutData[currentDay] = JSON.parse(clipboard);
            render();
        }
    }

    function render() {
        const list = document.getElementById('exercise-list');
        list.innerHTML = '';
        const dayExs = workoutData[currentDay];
        let charCode = 65; let ssCounter = 0;

        dayExs.forEach((ex, exIdx) => {
            if (exIdx > 0 && !ex.isSS) { charCode++; ssCounter = 1; }
            else { ssCounter++; }
            let itemIdx = String.fromCharCode(charCode) + ssCounter;

            const mod = document.createElement('div');
            mod.className = 'ex-module';
            mod.innerHTML = `
                <div class="module-tools">
                    <span onclick="toggleSS(${exIdx})" style="cursor:pointer; ${ex.isSS?'color:var(--primary); font-weight:bold;':''}">ğŸ”— è¶…ç´šçµ„</span> |
                    <span onclick="addSet(${exIdx})" style="cursor:pointer;">â• å¢çµ„</span> |
                    <span onclick="deleteEx(${exIdx})" style="cursor:pointer; color:var(--danger);">ğŸ—‘ï¸ åˆªé™¤</span>
                </div>
                ${ex.sets.map((s, sIdx) => `
                    <div class="ex-row ${ex.isSS ? 'ss-active' : ''}">
                        <div style="text-align:center; font-weight:bold;">${sIdx === 0 ? itemIdx : ''}</div>
                        <div>${sIdx === 0 ? `<input class="name-input" value="${ex.name}" onchange="updateEx(${exIdx},'name',this.value)">` : ''}</div>
                        <div><input type="text" value="${s.w}" placeholder="kg" oninput="updateSet(${exIdx},${sIdx},'w',this.value)"></div>
                        <div><input type="text" value="${s.r}" placeholder="æ¬¡" oninput="updateSet(${exIdx},${sIdx},'r',this.value)"></div>
                        <div style="text-align:center;"><button class="btn-check ${s.d?'done':''}" onclick="toggleCheck(${exIdx},${sIdx})">âœ“</button></div>
                    </div>
                `).join('')}
            `;
            list.appendChild(mod);
        });
    }

    // åŸºæœ¬é‚è¼¯
    function changeDay(idx) {
        currentDay = idx;
        document.querySelectorAll('.day-tab').forEach((t, i) => t.className = i === idx ? 'day-tab active' : 'day-tab');
        render();
    }
    function addExercise() { workoutData[currentDay].push({ name: 'æ–°å‹•ä½œ', rest: 60, isSS: false, sets: [{w:'', r:'', d:false}] }); render(); }
    function addSet(exIdx) { workoutData[currentDay][exIdx].sets.push({w:'', r:'', d:false}); render(); }
    function deleteEx(idx) { if(confirm("ç¢ºå®šåˆªé™¤å‹•ä½œï¼Ÿ")) { workoutData[currentDay].splice(idx,1); render(); } }
    function updateEx(idx, f, v) { workoutData[currentDay][idx][f] = v; }
    function updateSet(exIdx, sIdx, f, v) { workoutData[currentDay][exIdx].sets[sIdx][f] = v; }
    function toggleSS(idx) { workoutData[currentDay][idx].isSS = !workoutData[currentDay][idx].isSS; render(); }
    function toggleCheck(exIdx, sIdx) { workoutData[currentDay][exIdx].sets[sIdx].d = !workoutData[currentDay][exIdx].sets[sIdx].d; render(); }
    function showLoader(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }

    window.onload = loadFromCloud;
</script>
</body>
</html>