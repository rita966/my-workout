<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ’ªğŸ» å¥èº«èª²è¡¨</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #F5F2ED; --card: #FFFFFF; --primary: #8C7851; --accent: #B0A990;
            --text: #333; --ss-bg: #EAE7DC; --save: #6B705C; --danger: #CC6666;
        }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--text); padding-bottom: 70px; }
        .container { width: 100%; max-width: 600px; margin: 0 auto; padding: 15px; box-sizing: border-box; }
        
        /* åˆ†é åˆ‡æ› */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        .nav-item { flex: 1; text-align: center; padding: 15px 0; font-size: 12px; color: #888; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: bold; }

        /* æ—¥æ›†èˆ‡å¡ç‰‡ */
        .card { background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; margin-top: 10px; }
        .calendar-day { padding: 8px 0; border-radius: 8px; font-size: 12px; cursor: pointer; }
        .calendar-day.active { background: var(--primary); color: white; }
        .calendar-day.has-data::after { content: 'â€¢'; display: block; color: var(--save); margin-top: -5px; }

        /* å‹•ä½œæ¨¡çµ„æ¨£å¼ */
        .ex-module { border: 1px solid #EEE; margin-bottom: 12px; background: white; border-radius: 10px; overflow: hidden; }
        .module-tools { display: flex; gap: 10px; padding: 8px 12px; background: #FAFAFA; border-bottom: 1px solid #EEE; font-size: 11px; }
        .ex-row { display: grid; grid-template-columns: 40px 1fr 60px 60px 40px; gap: 4px; padding: 8px 5px; align-items: center; border-bottom: 1px solid #F9F9F9; }
        .ss-active { background: var(--ss-bg); }
        input, textarea { border: 1px solid #DDD; border-radius: 6px; padding: 6px; font-size: 13px; width: 100%; box-sizing: border-box; }
        .btn-check { height: 32px; width: 32px; border-radius: 6px; border: 1px solid #DDD; background: #EEE; }
        .btn-check.done { background: var(--save); color: white; border: none; }

        /* åœ–è¡¨å®¹å™¨ */
        canvas { width: 100% !important; height: 250px !important; }
        
        .loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:none; justify-content:center; align-items:center; z-index:2000; font-weight:bold; }
    </style>
</head>
<body>

<div id="loader" class="loading">åŒæ­¥ä¸­...</div>

<div class="container">
    
    <div id="page-train" class="tab-content active">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <button onclick="moveMonth(-1)">â—€</button>
                <b id="month-label"></b>
                <button onclick="moveMonth(1)">â–¶</button>
            </div>
            <div class="calendar-grid" id="calendar-days"></div>
        </div>

        <div class="card">
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <div style="flex:1">é«”é‡ <input type="number" id="weight" step="0.1"></div>
                <div style="flex:1">é«”è„‚ <input type="number" id="fat" step="0.1"></div>
            </div>
            <textarea id="day-note" placeholder="ğŸ“ ä»Šæ—¥è¨“ç·´å¿ƒå¾—å‚™è¨»..." rows="2"></textarea>
            <button onclick="saveToCloud()" style="width:100%; margin-top:10px; padding:10px; background:var(--save); color:white; border:none; border-radius:8px;">å„²å­˜ä¸¦åŒæ­¥é›²ç«¯</button>
        </div>

        <div id="exercise-list"></div>
        <button onclick="addExercise('train')" style="width:100%; padding:15px; border:2px dashed var(--accent); background:none; border-radius:10px; color:var(--primary); font-weight:bold;">+ æ–°å¢å‹•ä½œ</button>
    </div>

    <div id="page-library" class="tab-content">
        <h3>ğŸ“‹ èª²è¡¨æ¨¡æ¿åº«</h3>
        <p style="font-size:12px; color:#888;">åœ¨é€™è£¡å»ºç«‹ä½ çš„æ¨™æº–èª²è¡¨ï¼ˆå¦‚ï¼šèƒ¸èƒŒæ—¥ï¼‰ï¼Œå®Œæˆå¾Œå¯é»æ“Šã€Œå¥—ç”¨åˆ°æ—¥æ›†ã€ã€‚</p>
        <div id="library-list"></div>
        <button onclick="addExercise('library')" style="width:100%; padding:15px; border:2px dashed var(--accent); background:none; border-radius:10px; margin-bottom:20px;">+ å»ºç«‹æ¨¡æ¿å‹•ä½œ</button>
        <button onclick="applyTemplate()" style="width:100%; padding:15px; background:var(--primary); color:white; border:none; border-radius:10px; font-weight:bold;">ğŸ“¥ å°‡ä¸Šæ–¹å‹•ä½œå¥—ç”¨è‡³é¸å®šæ—¥æœŸ</button>
    </div>

    <div id="page-charts" class="tab-content">
        <div class="card">
            <h3>ğŸ“ˆ é«”é‡/é«”è„‚è¶¨å‹¢</h3>
            <canvas id="statsChart"></canvas>
        </div>
        <div id="history-summary" style="font-size:13px; line-height:1.6;"></div>
    </div>

</div>

<div class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('train', this)">ğŸ‹ï¸ è¨“ç·´</div>
    <div class="nav-item" onclick="switchTab('library', this)">ğŸ“‹ æ¨¡æ¿åº«</div>
    <div class="nav-item" onclick="switchTab('charts', this)">ğŸ“Š åœ–è¡¨</div>
</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzdppLufdX1_LV4Tz1Jo8OOiBswmVY2vEiGS19-fYQGVhLtyuqbJ1cnCPJ0c_rkC7y6oQ/exec';
    let selectedDate = new Date().toISOString().split('T')[0];
    let allData = {}; 
    let libData = JSON.parse(localStorage.getItem('chingyi_lib')) || [];
    let currentMonth = new Date();

    // --- åˆ†é åˆ‡æ› ---
    function switchTab(tabId, el) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById('page-' + tabId).classList.add('active');
        el.classList.add('active');
        if(tabId === 'charts') renderCharts();
        if(tabId === 'library') renderLibrary();
    }

    // --- æ—¥æ›†åŠŸèƒ½ ---
    function renderCalendar() {
        const grid = document.getElementById('calendar-days');
        document.getElementById('month-label').innerText = `${currentMonth.getFullYear()}å¹´ ${currentMonth.getMonth()+1}æœˆ`;
        grid.innerHTML = '';
        const firstDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1).getDay();
        const daysInMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0).getDate();
        for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement('div'));
        for(let d=1; d<=daysInMonth; d++) {
            const dateStr = `${currentMonth.getFullYear()}-${String(currentMonth.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day' + (dateStr === selectedDate ? ' active' : '') + (allData[dateStr] ? ' has-data' : '');
            dayEl.innerText = d;
            dayEl.onclick = () => { selectedDate = dateStr; renderCalendar(); loadDateData(); };
            grid.appendChild(dayEl);
        }
    }
    function moveMonth(s) { currentMonth.setMonth(currentMonth.getMonth()+s); renderCalendar(); }

    // --- è³‡æ–™åŒæ­¥ ---
    async function loadFromCloud() {
        showLoader(true);
        try {
            const res = await fetch(SCRIPT_URL);
            const raw = await res.json();
            allData = {};
            raw.slice(1).forEach(row => {
                const dateKey = row[0];
                allData[dateKey] = { workout: JSON.parse(row[1]), note: row[2], weight: row[3], fat: row[4] };
            });
            renderCalendar(); loadDateData();
        } catch(e) { console.error(e); }
        showLoader(false);
    }

    function loadDateData() {
        const data = allData[selectedDate] || { workout: [], note: '', weight: '', fat: '' };
        document.getElementById('day-note').value = data.note;
        document.getElementById('weight').value = data.weight;
        document.getElementById('fat').value = data.fat;
        renderWorkout('exercise-list', data.workout, true);
    }

    // --- æ¨¡æ¿åº«åŠŸèƒ½ ---
    function renderLibrary() {
        renderWorkout('library-list', libData, false);
    }
    function applyTemplate() {
        if(!allData[selectedDate]) allData[selectedDate] = { workout: [], note: '', weight: '', fat: '' };
        allData[selectedDate].workout = JSON.parse(JSON.stringify(libData));
        switchTab('train', document.querySelectorAll('.nav-item')[0]);
        loadDateData();
    }

    // --- ç¹ªè£½åœ–è¡¨ ---
    function renderCharts() {
        const dates = Object.keys(allData).sort();
        const weights = dates.map(d => allData[d].weight).filter(w => w > 0);
        const labels = dates.filter(d => allData[d].weight > 0);

        const ctx = document.getElementById('statsChart').getContext('2d');
        if(window.myChart) window.myChart.destroy();
        window.myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{ label: 'é«”é‡ (kg)', data: weights, borderColor: '#8C7851', tension: 0.3 }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    // --- æ¸²æŸ“å¼•æ“ (é€šç”¨) ---
    function renderWorkout(targetId, dataArr, isRealtime) {
        const list = document.getElementById(targetId);
        list.innerHTML = '';
        dataArr.forEach((ex, exIdx) => {
            const mod = document.createElement('div');
            mod.className = 'ex-module';
            mod.innerHTML = `
                <div class="module-tools">
                    <b style="color:var(--primary)">${ex.name}</b>
                    <span onclick="addSet('${targetId}', ${exIdx})">â• å¢çµ„</span> |
                    <span onclick="deleteEx('${targetId}', ${exIdx})" style="color:red">ğŸ—‘ï¸</span>
                </div>
                ${ex.sets.map((s, sIdx) => `
                    <div class="ex-row ${ex.isSS ? 'ss-active' : ''}">
                        <div>${sIdx+1}</div>
                        <div>${sIdx===0 ? `<input value="${ex.name}" onchange="updateEx('${targetId}',${exIdx},'name',this.value)">` : ''}</div>
                        <div><input type="text" value="${s.w}" placeholder="kg" oninput="updateSet('${targetId}',${exIdx},${sIdx},'w',this.value)"></div>
                        <div><input type="text" value="${s.r}" placeholder="æ¬¡" oninput="updateSet('${targetId}',${exIdx},${sIdx},'r',this.value)"></div>
                        <div style="text-align:center;"><button class="btn-check ${s.d?'done':''}" onclick="toggleCheck(${exIdx},${sIdx})">âœ“</button></div>
                    </div>
                `).join('')}
            `;
            list.appendChild(mod);
        });
    }

    // --- æ ¸å¿ƒé‚è¼¯ ---
    function updateEx(target, idx, f, v) { 
        let d = target==='library-list' ? libData : allData[selectedDate].workout;
        d[idx][f] = v; 
        if(target==='library-list') localStorage.setItem('chingyi_lib', JSON.stringify(libData));
    }
    function updateSet(target, exIdx, sIdx, f, v) {
        let d = target==='library-list' ? libData : allData[selectedDate].workout;
        d[exIdx].sets[sIdx][f] = v;
        if(target==='library-list') localStorage.setItem('chingyi_lib', JSON.stringify(libData));
    }
    function addExercise(type) {
        let newItem = { name: 'æ–°å‹•ä½œ', isSS: false, sets: [{w:'', r:'', d:false}] };
        if(type==='library') { libData.push(newItem); renderLibrary(); }
        else { 
            if(!allData[selectedDate]) allData[selectedDate]={workout:[],note:'',weight:'',fat:''};
            allData[selectedDate].workout.push(newItem); loadDateData(); 
        }
    }
    function addSet(target, idx) {
        let d = target==='library-list' ? libData : allData[selectedDate].workout;
        d[idx].sets.push({w:'', r:'', d:false});
        target==='library-list' ? renderLibrary() : loadDateData();
    }
    function deleteEx(target, idx) {
        let d = target==='library-list' ? libData : allData[selectedDate].workout;
        d.splice(idx,1);
        target==='library-list' ? renderLibrary() : loadDateData();
    }
    function toggleCheck(exIdx, sIdx) {
        allData[selectedDate].workout[exIdx].sets[sIdx].d = !allData[selectedDate].workout[exIdx].sets[sIdx].d;
        loadDateData();
    }
    async function saveToCloud() {
        showLoader(true);
        const dayData = { date: selectedDate, workout: allData[selectedDate].workout, note: document.getElementById('day-note').value, weight: document.getElementById('weight').value, fat: document.getElementById('fat').value };
        await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(dayData) });
        allData[selectedDate] = dayData;
        alert("å„²å­˜æˆåŠŸï¼"); renderCalendar();
        showLoader(false);
    }
    function showLoader(s) { document.getElementById('loader').style.display = s ? 'flex' : 'none'; }

    window.onload = loadFromCloud;
</script>
</body>
</html>
